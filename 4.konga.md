# GKE上にkongaをデプロイする
以下の手順で解説します。

1. [CloudDNS設定](./4.konga.md#1-CloudDNS設定)
2. [kongaのデプロイ](./4.konga.md#2-kongaデプロイ)
3. [ingressでkongaをhttps公開](./4.konga.md#3-ingressでkongaをhttps公開)

### 1 CloudDNS設定
発行した固定IPと「konga.ドメイン名」に設定したkongのホスト名をCloudDNS上で紐付けします。

#### 1-1.固定IPを取得する
konga-ipという名前に紐づけてグローバルな固定IPアドレスを取得します
```
gcloud compute addresses create konga-ip --global
```
※ ingressで公開するIPアドレスであるためGlobalである必要があります

参考）取得した固定IPをリストします
```
gcloud compute addresses list
```

#### 1-2.固定IPのホスト名を設定する
CloudDNSで以下のAレコードの追加します。ここでのホスト名はkonga.code4okazaki.orgとしています。
```
A [固定IPアドレスxx.xx.xx.xx] [ホスト名].
```
※ Google Cloud Platformコンソールのメニューから「ネットワークサービス」＞「Cloud DNS」で作成したドメインに相当するゾーン内で指定します。[お名前.comとCloud DNSの連携](https://www.nyamucoro.com/entry/2018/11/02/230332)を参照すると連携方法がわかります。

※ [固定IPアドレスxx.xx.xx.xx]には取得した固定IP、[ホスト名].にはお名前.com等で取得したドメインを使ったホスト名を指定します。

### 2 kongaデプロイ
kongaをNodePortサービスとしてデプロイします。

#### 2-1.konga.yamlをダウンロード
```
wget https://raw.githubusercontent.com/david3080/gke/main/konga.yaml
```

#### 2-2.kongaをデプロイ
```
kubectl apply -f konga.yaml
```

#### 2-3.NodePortサービスを作成する
deploymentをNodePortタイプ指定してexposeすることでNodePortサービスを作成します。
```
kubectl expose deployment konga --type=NodePort --name=konga --port=1337 --target-port=1337
```

### 3 ingressでkongaをhttps公開

#### 3-1.ingressでkongaサービスを公開する
GKE上のingressは、pathTypeにExactやPrefixを設定することができず、ImplementationSpecificのみをサポートしているため、kubectlコマンドのみで作成することはできず、yamlファイルを作って該当部分を編集してkubectl applyコマンドで実行します。
```
kubectl create ingress konga --rule="konga.code4okazaki.org/**=konga:1337,tls=tls-secret" --annotation kubernetes.io/ingress.global-static-ip-name=konga-ip --annotation cert-manager.io/cluster-issuer=letsencrypt-prod --annotation ingress.kubernetes.io/ssl-redirect=true --annotation nginx.ingress.kubernetes.io/force-ssl-redirect=true -o yaml --dry-run=client > kongaingress.yaml
```

#### 3-2.kongaingress.yamlのpathTypeをPrefixからImplementationSpecificに修正して保存します。

#### 3-3.kongaをingressで公開します
```
kubectl apply -f kongaingress.yaml
```

GCPコンソールの"Kubernetes Engine"の"ServiceとIngress"画面でIngressのステータスがOKになるのを待ってhttps接続します。

以上